# Testing the wide Column measure

## Setup the interface VPC endpoint

You can establish a private connection between your VPC and Amazon Timestream by creating an interface VPC endpoint. Interface endpoints are powered by AWS PrivateLink, a technology that enables the instances in your VPC to privately access Timestream APIs without public IP addresses. Traffic between your VPC and Timestream does not leave the Amazon network. 

1. Creating an interface VPC endpoint for Timestream 
- Constructing a VPC endpoint service name using your Timestream cell
```bash
aws timestream-query describe-endpoints --profile timestream-test --region us-east-1
{
    "Endpoints": [
        {
            "Address": "query-cell2.timestream.us-east-1.amazonaws.com",
            "CachePeriodInMinutes": 1440
        }
    ]
}
com.amazonaws.us-east-1.timestream.query-cell2

aws timestream-write describe-endpoints --profile timestream-test --region us-east-1
{
    "Endpoints": [
        {
            "Address": "ingest-cell2.timestream.us-east-1.amazonaws.com",
            "CachePeriodInMinutes": 1440
        }
    ]
}
com.amazonaws.us-east-1.timestream.ingest-cell2
```

## Create the sample database
1. On Timestream Console and create a database named `kdaflink`

2. Under the `kdaflink` database, create a table named `metrics200`

## Ingest data generator
1. Create the worker lambda function `TimestreamIngest` with [TimestreamIngest_lambda.py](scripts/TimestreamIngest_lambda.py). 
- The function will create a message contain 209 measures for 2 dimensions
- The function will sent out the multiple messages for each invocation. The number of message controlled by environment variable ``thread_number`, default is 50
- The thinking time is controlled by environment variable `sleep_time`, default is 0.1s
- The scale factor for the dimensions of each request, which is controlled by environment variable `scale_rate`, default is 1

2. Create the Main lambda function `TimestreamLoadTest` with the [TimestreamLoadTest](scripts/TimestreamLoadTest.py) to current invoke 50 the worker lambda function `TimestreamLoadTest`.

3. Setup the event bridge trigger interval as every 1 minute to invoke the Main lambda function `TimestreamLoadTest`

4. Monitoring

- You can monitor the ingested performance from Timestream Monitoring such as `Ingestion requests latency p95`
- You can monitor the lambda failure SQS destination `rtm-sim-failure`, make sure there is no failure
- You can monitor the lambda `TimestreamIngest` current execution


## Query the Data
1. Start EC2 inside the subnet which Timestream VPC endpoint located

2. Run the script

Using the script [query_test_wide_column.py](scripts/query_test_wide_column.py) to do query. Each SQL will running 5 times and calculate the average response time

```bash
python query_test.py

Running query [1] : [SELECT_WIDE_COLUMN]
### SELECT_WIDE_COLUMN
|Seq|spent_time          |query_id                                                              |scan_data MB        |
|1  |4.381443            |AEBQEAM4MXT35UHF23G6EY25HL44WNIMVCXW5XNQOMTCNW6LY3DQ6GYBV226C2Y       |9.710487
|2  |3.772316            |AEBQEAM4MXT7A64KNYO7V7QKTJ5YPAMJJFPZ6KDWK7IOJH7ZVM5BYIGZSSG6MZA       |9.710487
|3  |3.570056            |AEBQEAM4MXTSKG7HJ6VLFMMM5NCJLM2PPHM47TWCGXZGMB6IGFIDG5CFXHSL5OY       |9.710487
|4  |3.641499            |AEBQEAM4MXT53OCMYHPWUKQKHSOSCQHGKERYE7VIUDW3UOVPUQ7FJ7YW3C7GNWA       |9.710487
|5  |3.551869            |AEBQEAM4MXUMYNYNF3IANQT6GJIQDDK5GDMA2CTK5WGSYEIDIAST2APNHPHRQDA       |9.710487
|6  |3.509792            |AEBQEAM4MXUG3HISDGCRHGDLGI5AXZRRCMPOBNMORVWOJZ2US6PYILJOQUPLFVQ       |9.710487
|7  |3.363555            |AEBQEAM4MXUCTCPJFIRAJCNORJ3HXZAOZEBR3UXSOO2TSR7EQDKQUCPBMD5LPFY       |9.710487
|8  |4.666274            |AEBQEAM4MXUGSWHRYNP2AL6WUTVFNVEN3ROHS3IHVGKOYXW7GRMCGCWQAGYIVRQ       |9.710487
|9  |3.512196            |AEBQEAM4MXUCT5V7TYL5VWVEZXV77V7ONTXSUNSMDHYHJHBXJARBRUM6XOONLVI       |9.710487
|10 |3.910517            |AEBQEAM4MXUOPCH7FSME57E67A6XV7MYDI5LKXRLCXWCGO7QYDO7WVEZRPSGVZY       |9.710487
Average data scan for SELECT_WIDE_COLUMN is: 9.710487 MB
Average time for SELECT_WIDE_COLUMN is: 3.787952 s


Running query [2] : [SELECT_GROUP_BY]
### SELECT_GROUP_BY
|Seq|spent_time          |query_id                                                              |scan_data MB        |
|1  |0.861842            |AEBQEAM4MXUO572H4SW2GQR4KP2RJG26PUK2LAKAGPTDRF5ZFVLLDVG2GF5AZBQ       |9.710487
|2  |0.852343            |AEBQEAM4MXUH3KAMMLQRMNVBWNSBY7PEDIJLAFFUBEKOS3QN4QIWCD7XAQY3LIQ       |9.710487
|3  |0.798641            |AEBQEAM4MXUMF7W2Q3WMRRHMKZRRIKBUJNTHUHJFLUP3FCCHE3C33I7LYDJNIGQ       |9.710487
|4  |0.790878            |AEBQEAM4MXUA3QOKUWRWY5EFSHEVT5IU3KYTIUNQJIK457QQ72MVRFWZ7UUIHWY       |9.710487
|5  |0.770696            |AEBQEAM4MXUG6DF3DHZOWDV7O6FJHW3VUCV7UQ4JYH2EHFHV3C5CFXDZ2GZQYKY       |9.710487
|6  |0.780798            |AEBQEAM4MXUCSPJPRLN6WDHY4GFSP6BAMGLQSWAZ6FBNCQ7LGH7C5O4MPEPO5EY       |9.710487
|7  |0.831140            |AEBQEAM4MXUE2FQJLB5QILLGX23OY363KM3S6MBYKXJG6G6J4EI2H57OG3GLZLA       |9.710487
|8  |0.761441            |AEBQEAM4MXULPVWC67NBDMTCP2GGMO5CNNGPPV7GGENJGGNAQGRW4FU2KW7S27A       |9.710487
|9  |0.782837            |AEBQEAM4MXUJBY2N4B3ZVEWMO7BYDC6LXQTU734EPWYKB3UTKYBBLGA4JFSTZXY       |9.710487
|10 |0.791776            |AEBQEAM4MXUIXKF3RCCQ2HBIJPLT3KA4V4VP42Z6BRWWMLUS7DOSI4VLFSS4ZVI       |9.710487
Average data scan for SELECT_GROUP_BY is: 9.710487 MB
Average time for SELECT_GROUP_BY is: 0.802239 s


Running query [3] : [SELECT_MAX]
### SELECT_MAX
|Seq|spent_time          |query_id                                                              |scan_data MB        |
|1  |0.800853            |AEBQEAM4MXUK4XJAV4CLHZED5DUJZQVXL4O6DIYNTPARZQ6Y7L7OM4CIH5RIFCA       |9.710487
|2  |0.761112            |AEBQEAM4MXUDUWJZPSWH7BT6HKYHOQTSEWD6ZK4NMOTSQTLHNYQZDUFZBHREKHA       |9.710487
|3  |0.760327            |AEBQEAM4MXUMU3NLLSCWOGGHI77ZEY7FCBFK6QRZRNK34SI6JPA47N2F33SRPNQ       |9.710487
|4  |0.761142            |AEBQEAM4MXUN6BZRPRSCH5RH4URHI2IH5TIJEWI23IYXR2QQBVDFR75A7HBPIRY       |9.710487
|5  |0.750518            |AEBQEAM4MXUG7QTJZLQ442UUUW5EB3TAUSTALIHTRSKTXVKBGHCGJSL6CS62BZA       |9.710487
|6  |0.780557            |AEBQEAM4MXUCPDGXYYSIPJINRLYTFD4HCETDMJJJSYGQ4NQJKPGSKBKK2XQDHZA       |9.710487
|7  |0.760734            |AEBQEAM4MXUPT67ID6EXPVDBB3QKKC45OZ3KN3NV6VLLHNWMGCMNROLMWHFKFMA       |9.710487
|8  |0.800443            |AEBQEAM4MXUO4ALLCS2SXXZABWMJ2UZNY4KYGCG2UKJVVH4VLF4KGISWOIZQOXA       |9.710487
|9  |0.759419            |AEBQEAM4MXUOZ6XUFLDGHOC4PXKTPJLAILM6E5QGCZ4ZEKKEQWSMOITHYTFAL5Q       |9.710487
|10 |0.790575            |AEBQEAM4MXUBJFX2IKZBT6ONVFKSGDOCI4ZJRTTNUSJGBNZAQ7K2RYTEA6Y43GA       |9.710487
Average data scan for SELECT_MAX is: 9.710487 MB
Average time for SELECT_MAX is: 0.772568 s


Running query [4] : [SELECT_BIN]
### SELECT_BIN
|Seq|spent_time          |query_id                                                              |scan_data MB        |
|1  |0.871441            |AEBQEAM4MXUMOSIR54ZWZ3I7INLSUI3AIVTQ2UC4NKI4FPQ3J33JYQD3OA4KOIQ       |9.710487
|2  |0.780532            |AEBQEAM4MXUO3KA27AKSR37ZM6ATB6PMNJV4MHWJLMO47TDTPINAQC4DPYEE5BA       |9.710487
|3  |0.820894            |AEBQEAM4MXUNSU377P22UU2ECBDQZTSUFFL5OOFC5SQZWMGV7UVMANQS6QFQTPQ       |9.710487
|4  |0.770810            |AEBQEAM4MXUCWNBG2RF6D2RIKLHBFXBF5VQJ4UIV54UOZNMFZMDD5H6YLTXWLBA       |9.710487
|5  |0.791368            |AEBQEAM4MXUD67273UTOBXNF4XZGHGFEA2TUGZIHAEFAVDSTNKP65KGJ2ADMGZY       |9.710487
|6  |0.770404            |AEBQEAM4MXULF6RN5GMAGLONT5SBFF4AW4EEDSGMZ774E624UTLHQPSEHB7K3AY       |9.710487
|7  |0.831378            |AEBQEAM4MXUCTZKS233YE5BVZ4VO3ILSQM4NPDIFYF3OB7K4H4EPO7EKASDSVGQ       |9.710487
|8  |0.770754            |AEBQEAM4MXUGKRT5P2LWOKN3DFMEG5LR2SFHC5XZJVXDVG2GO6BYODKY7GUSWCY       |9.710487
|9  |0.741568            |AEBQEAM4MXUHXM5CGCROTCZJ7OODSKKE6ND2MG6KPIPBTLPGIZLFPVC26TAF42Q       |9.710487
|10 |0.770384            |AEBQEAM4MXUJBNNUWUXFKSKBKQAQQL5PSOZAARCKBESHZTBRKQNOPLVZGGIVZPA       |9.710487
Average data scan for SELECT_BIN is: 9.710487 MB
Average time for SELECT_BIN is: 0.791953 s


Running query [5] : [SELECT_TRUNC]
### SELECT_TRUNC
|Seq|spent_time          |query_id                                                              |scan_data MB        |
|1  |0.840661            |AEBQEAM4MXUF63GA6ARVHULZPEAK6JX43X6CJ3EVD2X5OREUP5OC26NNTWS57AQ       |9.710487
|2  |0.802412            |AEBQEAM4MXUEOSIISJTMIZJAHYOWJDW6TW5BWDSC5XDOJKZDWMQ5KSD47Y4BTWI       |9.710487
|3  |0.810767            |AEBQEAM4MXUEX7VRS6XETNRFTFF3SK62V7ELAS5OJPSK3YQRYL2RPPH5TBJB6EY       |9.710487
|4  |0.771687            |AEBQEAM4MXUL5KVRV3ME64YBLOSXSZJY7G57LLQY6QHVMKY6RDJSEPCR7HYRAGQ       |9.710487
|5  |0.812418            |AEBQEAM4MXUD7KILTB4YSORQE7W7FLEFUKZO6ZWG4CZUX7ZUKK2K2XVWCIV3GOY       |9.710487
|6  |0.790967            |AEBQEAM4MXUECOUYFPAAJGVKALFRTLRHRLLN5LW55FX2QQSCB6EAVHWKUUW4RNY       |9.710487
|7  |0.870826            |AEBQEAM4MXUKWTNN3JGPPWKWGWROZQ7ECWZG3B5X52GWG2X3LYXVSLIJIND357A       |9.710487
|8  |0.791331            |AEBQEAM4MXUOXFUIUDDQXFXBKVOMMPITWX3FYKRXZKXF7S7SDYMSIRHEG4TV6JY       |9.710487
|9  |0.780826            |AEBQEAM4MXULBDNH3NEPTUZ2PYC3IPKSUSD3UXTY3WYL3DEU73LZQ6AEYRZTCYY       |9.710487
|10 |0.831854            |AEBQEAM4MXUN36DUKYE26FCOH3GIJVNRUPAMOUT27KJGYPS7YP2A35SKXO4RCDI       |9.710487
Average data scan for SELECT_TRUNC is: 9.710487 MB
Average time for SELECT_TRUNC is: 0.810375 s


Running query [6] : [SELECT_ARBIT]
### SELECT_ARBIT
|Seq|spent_time          |query_id                                                              |scan_data MB        |
|1  |0.781801            |AEBQEAM4MXUDD7EWXPJJ4JVP65HTTRC6DORYVBIVXCRQHZVONQLVSTPVFFS6I5Y       |9.710487
|2  |0.771501            |AEBQEAM4MXUM5CHWVXWXABNZCW6WFASJZEFYPQZYLXPBNIAV4GVZ5LYQGQY6FXQ       |9.710487
|3  |0.941874            |AEBQEAM4MXUBYL4MSPMCU5WTRIDMS42JILYJHGMAGUKZDWHKJPBBXLR4TWP3R4I       |9.710487
|4  |0.801240            |AEBQEAM4MXUIXPL2KLTW2VIY7RREONESZKNVZUSRKGOC5RNVIQK4RSSQTHWHGFY       |9.710487
|5  |0.831550            |AEBQEAM4MXUIU5IB6NMF65QOXDCVTVZALMNIT7CTSJDMM7FT5OX5M5YMMSLUXGI       |9.710487
|6  |0.781539            |AEBQEAM4MXUYCC533HIA6VTCYVYEVOICOAPODW7BUJ52OJKPEHIPFHFCOPI22PA       |9.710487
|7  |0.821245            |AEBQEAM4MXUXXLVQRFGQFSFM24AH7T446TTKCMEJO2HZL7FW5X4WC6QHZNAUMFI       |9.710487
|8  |0.841912            |AEBQEAM4MXUSEKBMXCZ7CRVJMPN7VGDHPL2G5GSIYBOVP75H7I2RKBLZSSG35AQ       |9.710487
|9  |0.791297            |AEBQEAM4MXU5ORMLSRVPPWENVN6DW2WKDEIHVDKSXFESIPQ6YWK7IZYAHNPL7VI       |9.710487
|10 |0.770537            |AEBQEAM4MXUX6EFEHYMYVELAQLL3LO3I5QQ2YWF3BBZ65RUC5UTL3WAETQQQ36I       |9.710487
Average data scan for SELECT_ARBIT is: 9.710487 MB
Average time for SELECT_ARBIT is: 0.813450 s


Running query [7] : [SELECT_NTH_VALUE]
### SELECT_NTH_VALUE
|Seq|spent_time          |query_id                                                              |scan_data MB        |
|1  |1.033939            |AEBQEAM4MXU24O3Y4GIWWBSFVBIELHZOAFPGNUTZPFN5RV2FXHF5HDAEWDBBHCY       |9.710487
|2  |0.926923            |AEBQEAM4MXUYNWTI2IKLN5P6CBF3WBIFCMGKAAQ7OSTUOOPUZ2OZZO5HNCPSUTA       |9.710487
|3  |0.855744            |AEBQEAM4MXUSYDQSFSYKIIMLELBGMYYUXITCRZL2JN5EGDFQJ63YPKQAAXD23RA       |9.710487
|4  |0.795663            |AEBQEAM4MXU23MR7V4YQI432DNKKHWZV6TZTOTRX4CHCKVS7OUX53A24ZSRAOLA       |9.710487
|5  |0.805766            |AEBQEAM4MXUZZWC7QMKRHQ65I5EPC6LMW7LGNKI7G7KYPIY7NWHZF3JRCX5MTWY       |9.710487
|6  |0.866723            |AEBQEAM4MXUYDE6KURBIHITMAULPCQHYFINQYAFEYFNVOAFIV4YRNAV7KHML22I       |9.710487
|7  |0.822265            |AEBQEAM4MXUWWTT3ALH37WJFYMRESQKGDXQ7FORZYH3DWQHPXBVHM3TQJTZMKZQ       |9.710487
|8  |0.886381            |AEBQEAM4MXUS2EUIGFQEUCSMH3XFM6YO6PHQ67MWYFKHADUJKJQQVXGSIPJFRKY       |9.710487
|9  |0.815120            |AEBQEAM4MXURBQTSTPWVT6PAOWFWJ3FE4GUMPV3F56KYIT4XODBB36NCHB5GK6Q       |9.710487
|10 |0.865841            |AEBQEAM4MXUUFXIBVLSP2OEFKHZZOL2WKZ5D6NFUYJLGGEE4PLL4PMXSOQPPUPY       |9.710487
Average data scan for SELECT_NTH_VALUE is: 9.710487 MB
Average time for SELECT_NTH_VALUE is: 0.867436 s
```


